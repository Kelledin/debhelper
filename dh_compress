#!/usr/bin/perl -w
#
# Compresses files and makes sure that symlinks pointing to the 
# compressed files get fixed.

use Cwd;
BEGIN { push @INC, "debian", "/usr/lib/debhelper" }
use Dh_Lib;
init();

foreach $PACKAGE (@{$dh{DOPACKAGES}}) {
	$TMP=tmpdir($PACKAGE);
	$compress=pkgfile($PACKAGE,"compress");

	# Run the file name gathering commands from within the directory
	# structure that will be effected.
	$olddir=getcwd();
	chdir($TMP) || error("Can't cd to $TMP: $!");

	# Figure out what files to compress.
	@files=();
	# First of all, deal with any files specified right on the command line.
	if (($PACKAGE eq $dh{FIRSTPACKAGE} || $dh{PARAMS_ALL}) && @ARGV) {
		push @files,#ARGV;
	}
	if ($compress) {
		# The config file is a sh script that outputs the files to be compressed
		# (typically using find).
		push @files, split(/\n/,`sh $olddir/$compress 2>/dev/null`);
	}
	else {
		# By default, fall back to what the policy manual says to compress.
		push @files, split(/\n/,`
			find usr/info usr/man usr/X11*/man -type f ! -name "*.gz" 2>/dev/null || true;
			find usr/doc -type f \\( -size +4k -or -name "changelog*" \\) \\
				! -name "*.htm*" ! -name "*.gif" ! -name "*.gz" \\
				! -name "copyright" 2>/dev/null || true
		`);
	}

	# Exclude files from compression.
	if (@files && defined($dh{EXCLUDE}) && $dh{EXCLUDE}) {
		@new=();
		foreach (@files) {
			$ok=1;
			foreach $x (@{$dh{EXCLUDE}}) {
				if (/\Q$x\E/) {
					$ok='';
					last;
				}
			}
			push @new,$_ if $ok;
		}
		@files=@new;
	}
	
	# Look for files with hard links. If we are going to compress both,
	# we can preserve the hard link across the compression and save
	# space in the end.
	foreach (@files) {
		($dev, $inode, undef, $nlink)=stat($_);
		if ($nlink > 1) {
			@{$hardlinks{$_}}=($dev,$inode);
		}
	}
	# TODO: with the info we have now, we could remove the hard link files
	# from the list of files to compress and save some time.

	if (@files) {
		doit("gzip","-9f",@files);
	}
	
	# Now change over any files we can that used to be hard links so
	# they are again.
	my $old_dev='';
	my $old_inode='';
	my $old_fn='';
	foreach (sort keys %hardlinks) {
		if ($hardlinks{$_}[0] eq $old_dev &&
		    $hardlinks{$_}[1] eq $old_inode) {
		    	doit("rm","-f","$_.gz");
			doit("ln","$old_fn.gz","$_.gz");
		}	
	    	$old_dev=$hardlinks{$_}[0];
		$old_inode=$hardlinks{$_}[1];
		$old_fn=$_;
	}

	chdir($olddir);

	# Fix up symlinks that were pointing to the uncompressed files.
	open (FIND,"find $TMP -type l |");
	while (<FIND>) {
		chomp;
		($directory)=m:(.*)/:;
		$linkval=readlink($_);
		if (! -e "$directory/$linkval" && -e "$directory/$linkval.gz") {
			doit("rm","-f",$_);
			doit("ln","-sf","$linkval.gz","$_.gz");
		}
	}
}
