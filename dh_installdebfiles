#!/bin/sh -e
#
# Install files from debian/ into the package's DEBIAN directory.
# Also generates the control file.

PATH=debian:$PATH:/usr/lib/debhelper
. dh_lib

for PACKAGE in $DH_DOPACKAGES; do
	TMP=`tmpdir $PACKAGE`
	EXT=`pkgext $PACKAGE`

	if [ ! -d debian/$TMP/DEBIAN ]; then
		doit "install -o root -g root -d debian/$TMP/DEBIAN"
	fi

	# Install debian install scripts.
	# If any .debhelper files exist, add them into the scripts.
	for file in postinst preinst prerm postrm; do
		if [ -f debian/$EXT$file ]; then
			# Add this into the script, where it has #DEBHELPER#
			if [ -f debian/$EXT$file.debhelper ]; then
				verbose_echo "perl -pe \"s~#DEBHELPER#~qx{cat debian/$EXT$file.debhelper}~eg\" < debian/$EXT$file > debian/$TMP/DEBIAN/$EXT$file"
				perl -pe "s~#DEBHELPER#~qx{cat debian/$EXT$file.debhelper}~eg" < debian/$EXT$file > debian/$TMP/DEBIAN/$EXT$file
				doit "chown root.root debian/$TMP/DEBIAN/$EXT$file"
				doit "chmod 755 debian/$TMP/DEBIAN/$EXT$file"
			else
				doit "install -o root -g root -p debian/$EXT$file debian/$TMP/DEBIAN/"
			fi
		else
			# Auto-generate script header and add .debhelper
			# content to it.
			if [ -f debian/$EXT$file.debhelper ]; then
				verbose_echo "echo '#!/bin/sh -e' > debian/$TMP/DEBIAN/$EXT$file"
				echo '#!/bin/sh -e' > debian/$TMP/DEBIAN/$EXT$file
				verbose_echo "cat debian/$EXT$file.debhelper >> debian/$TMP/DEBIAN/$EXT$file"
				cat debian/$EXT$file.debhelper >> debian/$TMP/DEBIAN/$EXT$file
				doit "chown root.root debian/$TMP/DEBIAN/$EXT$file"
				doit "chmod 755 debian/$TMP/DEBIAN/$EXT$file"
			fi
		fi
	done

	# Install non-executable files
	for file in shlibs conffiles; do
		if [ -f debian/$EXT$file ]; then
			doit "install -o root -g root -m 644 -p debian/$EXT$file debian/$TMP/DEBIAN"
		fi                                               
	done

	# Run dpkg-shlibdeps to generate dependancies.
	filelist=""
	for file in `find debian/$TMP -type f \( -perm +111 -or -name "*.so*" \) | tr "\n" " "` ; do
		case "`file $file`" in
			*ELF*)
				filelist="$file $filelist"
			;;
		esac
	done
	if [ "$filelist" ]; then
		doit "dpkg-shlibdeps -Tdebian/${EXT}substvars $filelist"
	fi

	# Generate and install control file.
	doit "dpkg-gencontrol -p$PACKAGE -Tdebian/${EXT}substvars -Pdebian/$TMP"
	doit "chown root.root debian/$TMP/DEBIAN/control"
done
